---
output: 
  rmdformats::html_clean:
#  html_document:
#    theme: readable
#    toc: true
#    toc_float: 
#      collapsed: false
#      smooth_scroll: false 
    thumbnails: false 
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE,
                      comment=FALSE)
require(SASmarkdown)

saspath <- "C:/Program Files/SASHome/SASFoundation/9.4/sas.exe"
#saspath <- "sas"
```

# (Natural) Cubic Spline Regression

Splines based on cubic polynomials have been found to have nice properties with a good ability to fit sharply curving shapes. The smoothness constraints for cubic splines force the cubic polynomials for adjacent segments and their $1^{st}$ and $2^{nd}$ derivatives to be continuous (agree) at the join points (knots). A cubic spline with $k+1$ knots $(\eta_1 < \eta_2 < \ldots < \eta_{k+1})$ is given by
$$\beta_0 + \beta_1 x + \beta_2 x^2 + \beta_3 x^3 + \beta_4 (x-\eta_1)_+^3 + \beta_5 (x-\eta_2)_+^3 + \ldots \beta_{k+3} (x-\eta_{k})_+^3 + \beta_{k+4} (x-\eta_{k+1})_+^3$$
On each of the $k+2$ intervals, the cubic spline is a cubic polynomial, but the coefficients of the cubic polynomials differ across intervals. 

Cubic spline functions can be very poorly behaved in the tails (before the first knot and after the last knot).  The *natural (or restricted) cubic spline* function addresses this problem by constraining the function to be linear (not cubic) in the tails. With $k+1$ knots, the natural cubic spline is a function with $k$ parameters (not including the intercept) instead of $k+4$ for the unrestricted cubic spline. A natural cubic spline with $k$ degrees of freedom/parameters (or $k+1$ knots) is given by
$$\beta_0 + \beta_1 x + \beta_2 N_1(x) + \beta_2 N_2(x) + \ldots + \beta_k N_{k-1}(x)$$
where
$$N_j(x) = d_j(x) - d_k(x),~~j = 1, 2, \ldots, k-1$$
$$d_j(x) = \frac{(x-\eta_j)_+^3 - (x-\eta_{k+1})_+^3}{\eta_{k+1} - \eta_j},~~j = 1, 2, \ldots, k$$
It is easy to see that this function is linear before the first knot. It can be shown that the function is cubic between the knots and linear after the final knot.  

The functions $x, N_1(x), N_2(x), \ldots, N_{k-1}(x)$ are a set of *basis* functions (called the *truncated power* basis) for a natural cubic spline with $k+1$ knots. A natural cubic spline can be represented with many different sets of basis functions. The design matrix for natural cubic splines based on B-splines is more numerically stable than the design matrix based on the truncated power basis. However, B-splines are more complex and do not allow for extrapolation beyond the final knot. The truncated power basis is more intuitive than the B-spline basis, and it seldom presents estimation problems when modern methods are used for matrix inversion. In many SAS procedures, the EFFECT statement can be used to obtain the natural spline basis functions. For other SAS procedures, the RCSPLINE macro written by Frank Harrell can be used to calculate the appropriate spline basis functions. Other statistical programs (R and Stata) also provide similar tools for obtaining design matrices for natural cubic splines.

For a natural cubic spline regression model with $k$ degrees of freedom ($k+1$ knots), the overall $F$-test $(H_0: \beta_1 = \beta_2 = \ldots = \beta_k = 0)$ and the partial $F$-test for linearity $(H_0: \beta_2 = \beta_3 = \ldots = \beta_k = 0)$ are always interesting. 

The truncated power basis of the natural cubic spline allows for linear extrapolation beyond the range of the observed data. However, extrapolation is still dangerous and should only be done with caution.

### Number and Placement of Knots

We assume that the locations of the knots were specified in advance; that is, the knot locations are not treated as parameters to be estimated. If knots were treated as parameters, the fitted function would have more flexibility but at the cost of instability of estimates, statistical inference problems and inability to use standard regression modeling software. Ideally, the knots could be placed based on scientific insights regarding (potential) changes in the behavior of the predictor/response relationship. However, in most situations, there is little, if any, information on (potential) change points/knot locations. Fortunately, it turns out that the location of the knots is not crucial in most situations; the fit depends much more on the number of knots $k+1$. Placing the knots at fixed quantiles (percentiles) of the marginal distribution of the predictor variable is a good approach in most datasets. Recommended default quantiles for knot locations are

df | knots | Percentiles
-- | --- | --
2 | 3 | 10, 50, 90
3 | 4 | 5, 35, 65, 95
4 | 5 | 5, 27.5, 50, 72.5, 95
5 | 6 | 5, 23, 41, 59, 77, 95
6 | 7 | 2.5, 18.33, 34.17, 50, 65.83, 81.67, 97.5

What about the number of knots? For many datasets, a natural cubic spline with 4 df represents an appropriate balance between flexibility and loss of precision caused by overfitting a small sample. Small samples ($N < 30$) may require the use of 2 df, and moderate samples ($N < 100$) may require the use of 3 df. Empirical evidence suggests that more than 4 df are seldom required in a natural cubic spline regression model. Cubic spline models with 5 or 6 df would typically only be considered if the sample size was very large.

To illustrate a natural cubic spline regression model, we will construct a logistic regression model for obesity as a function of age for the US adult (age 20-80) population.

We denote the obesity outcome for subject $i$ by $y_i$ and the age for subject $i$ by $x_i$. 

Our logistic regression model is 
$$ y_i \sim \mbox{Bernoulli}\left\{p_i\right\} \\
\mbox{logit}\left\{p_i\right\} = \log{\left\{\frac{p_i}{1-p_i}\right\}} = \beta_0 + \beta_1 x_i + \beta_2 N_1(x_i) + \beta_3 N_2(x_i) + \beta_4 N_3(x_i)$$
where 
$$N_1(x) = d_1(x) - d_4(x)$$ $$N_2(x) = d_2(x) - d_4(x)$$ $$N_3(x) = d_3(x) - d_4(x)$$
$$d_1(x) = \frac{(x-22)_+^3 - (x-79)_+^3}{79 - 21}$$ $$d_2(x) = \frac{(x-34)_+^3 - (x-79)_+^3}{79 - 34}$$ $$d_3(x) = \frac{(x-46)_+^3 - (x-79)_+^3}{79 - 46}$$ $$d_4(x) = \frac{(x-58)_+^3 - (x-79)_+^3}{79 - 58}$$

The PERCENTILELIST(5 27.5 50 72.5 95) option in the EFFECT statement was used to place knots at the recommended percentiles.

```{r example1, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
LIBNAME NHANES "../../../BMI552_Datasets/NHANES_May2023/";
*LIBNAME NHANES "~/my_shared_file_links/u48718377/NHANES";
OPTIONS FMTSEARCH=(NHANES.formats_NHANES work) NODATE NONUMBER;
TITLE1; TITLE2;
ODS NOPROCTITLE;
ODS GRAPHICS / LOESSMAXOBS=20000;

DATA Ron;
  SET NHANES.NHANES;
RUN;

DATA AllAges;
  DO Age = 20 TO 80 BY 1;
    OUTPUT;
  END;
RUN;

ODS EXCLUDE ALL;
PROC LOGISTIC DATA=Ron;
  CLASS Age;
  MODEL Obese(Event="Yes") = Age / LINK=LOGIT;

  STORE Categorical;
RUN;

PROC LOGISTIC DATA=Ron;
*  ODS SELECT SplineKnots;
  EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) DEGREE=3 KNOTMETHOD=PERCENTILELIST(5 27.5 50 72.5 95) DETAILS);
  MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;    
  
  OUTPUT OUT=Tmp RESCHI=Residual PREDICTED=Fitted; 
    
  STORE NaturalCubicSpline;
RUN;

PROC PLM RESTORE=Categorical;
    SCORE DATA=AllAges OUT=FItted1 Predicted=Categorical / ALPHA=0.03125;
RUN;

PROC PLM RESTORE=NaturalCubicSpline;
    SCORE DATA=AllAges OUT=Fitted2 Predicted=NaturalCubicSpline / ALPHA=0.03125;
RUN;

DATA Fitted;
  MERGE Fitted1 Fitted2;
  BY Age;
RUN;
ODS EXCLUDE NONE;

PROC SGPLOT DATA=Fitted NOAUTOLEGEND;
  SERIES X=Age Y=Categorical / LINEATTRS=(PATTERN=Solid) LEGENDLABEL="Age (Categorical)";
  SERIES X=Age Y=NaturalCubicSpline / LINEATTRS=(COLOR=Cx1b9e77 PATTERN=Solid) LEGENDLABEL="Age (Natural Cubic Spline)";
  YAXIS LABEL="Logit (Log Odds) of Obesity";
RUN;
```

# Assessing Adequacy of Modeling Assumptions

Before proceeding to inference, we should evaluate the adequacy of the modeling assumptions. In this case, the only assumptions are correct structural model and independence (which cannot be evaluated based on the observed data).  Potential violations of the correct structural model assumption can be assessed formally by fitting higher-order polynomials or informally using plots of the Pearson residuals $r_i = \frac{y_i - \hat{p}_i}{\sqrt{\hat{p}_i(1-\hat{p}_i)}}$ against the predictor variable $x_i$. In binary regression, it is essential to add a *scatterplot smoother* as a *plot enhancement* to identify any structural problems with the model.

```{r example3, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
PROC SGPLOT DATA=Tmp;
  LOESS X=Age Y=Residual / DEGREE=2 JITTER; 
  REFLINE 0 / AXIS=Y;
RUN;
```

The lack of any clear pattern in this plot suggests that the correct structural model assumption is not violated.

# Regression Coefficient Estimates (SAS)

The regression coefficients $\beta_1, \beta_2, \beta_3, \beta_4$ in a natural cubic spline regression lack any meaningful interpretation.

```{r coefs, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
PROC PLM RESTORE=NaturalCubicSpline;
  ODS SELECT ParameterEstimates;
  SHOW Parms;
RUN;
```

# Estimates of Probabilties

Using ESTIMATE statements, one can easily specify desired estimates using non-positional syntax. Using non-positional syntax, SAS will calculate all of the spline terms required to estimate the log odds for a given age automatically.

```{r example4, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS EXCLUDE ALL;
PROC PLM RESTORE=NaturalCubicSpline;
    ODS OUTPUT Estimates=E;

    ESTIMATE "Age 30" Intercept 1 AgeCS [1, 30] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 40" Intercept 1 AgeCS [1, 40] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 50" Intercept 1 AgeCS [1, 50] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 60" Intercept 1 AgeCS [1, 60] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 70" Intercept 1 AgeCS [1, 70] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 80" Intercept 1 AgeCS [1, 80] / CL ILINK ALPHA=0.03125;
RUN;
ODS EXCLUDE NONE;

PROC PRINT DATA=E NOOBS LABEL;
    VAR Label LowerMu Mu UpperMu;
    LABEL Label='00'x
        Mu="Estimate"
        LowerMu="Lower CL"
        UpperMu="Upper CL";
    TITLE "Prevalence of Obesity";
RUN;
TITLE;
```

The estimated prevalence of obesity is $(0.340,0.389)$ for 30 year olds, $(0.352,0.395)$ for 40 year olds, $(0.339,0.386)$ for 50 year olds, $(0.381,0.434)$ for 60 year olds, $(0.350,0.399)$ for 70 year olds and $(0.259,0.340)$ for 80 year olds.

# Estimates of Odds Ratios

Using non-positional syntax, we can also easily estimate log odds ratio for comparisons between two ages.  First, we present a series of comparisons of ages 30, 40, 60, 70 and 80 with age 50, essentially using age 50 as a common reference point. 

```{r example5, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS EXCLUDE ALL;
PROC PLM RESTORE=NaturalCubicSpline;
    ODS OUTPUT Estimates=E;

    ESTIMATE "Age 30 v 50" AgeCS [1, 30] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 40 v 50" AgeCS [1, 40] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 60 v 50" AgeCS [1, 60] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 70 v 50" AgeCS [1, 70] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 80 v 50" AgeCS [1, 80] [-1, 50] / CL EXP ALPHA=0.03125;
RUN;
ODS EXCLUDE NONE;

PROC PRINT DATA=E NOOBS LABEL;
    VAR Label LowerExp ExpEstimate UpperExp;
    LABEL Label='00'x
        LowerExp="Lower CL"
        ExpEstimate="Estimate"
        UpperExp="Upper CL";
    TITLE "Odds Ratio";
RUN;
TITLE;
```

The estimated odds ratio for obesity is $(0.85,1.20)$ for 30 year olds vs. 50 year olds, $(0.95,1.16)$ for 40 year olds vs. 50 year olds, $(1.06,1.39)$ for 60 year olds vs. 50 year olds, $(0.91,1.23)$ for 70 year olds vs. 50 year olds and $(0.60,0.93)$ for 80 year olds vs. 50 year olds.

Next, we present a series of comparisons between ages one decade apart (40 v. 30, 50 v. 40, 60 v. 50, 70 v. 60, 80 v. 70).  Direct comparisons of these estimates are more meaningful as they represent the *effect* of identical increases in age (10 years) from a variety of different starting points.


```{r example16, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS EXCLUDE ALL;
PROC PLM RESTORE=NaturalCubicSpline;
    ODS OUTPUT Estimates=E;

    ESTIMATE "Age 40 v 30" AgeCS [1, 40] [-1, 30] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 50 v 40" AgeCS [1, 50] [-1, 40] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 60 v 50" AgeCS [1, 60] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 70 v 60" AgeCS [1, 70] [-1, 60] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 80 v 70" AgeCS [1, 80] [-1, 70] / CL EXP ALPHA=0.03125;
RUN;
ODS EXCLUDE NONE;

PROC PRINT DATA=E NOOBS LABEL;
    VAR Label LowerExp ExpEstimate UpperExp;
    LABEL Label='00'x
        LowerExp="Lower CL"
        ExpEstimate="Estimate"
        UpperExp="Upper CL";
    TITLE "Odds Ratio";
RUN;
TITLE;
```

The estimated odds ratio for obesity is $(0.93,1.15)$ for 40 year olds vs. 30 year olds, $(0.86,1.06)$ for 50 year olds vs. 40 year olds, $(1.06,1.39)$ for 60 year olds vs. 50 year olds, $(0.80,0.95)$ for 70 year olds vs. 60 year olds and $(0.60,0.84)$ for 80 year olds vs. 70 year olds.

# Overall Test

Comparisons of the log odds of obesity at two different ages are most naturally assessed using confidence (compatibility) intervals rather than hypothesis tests, because the connection between the odds ratio and the (relative) prevalence in the two groups is relatively straightforward.  The global null hypothesis of no *effect* of age on the log odds of obesity, e.g. the log odds of obesity is the same for all ages, can be tested using a likelihood ratio test. 

The *overall test* for age is the test of the hypotheses
$$\begin{eqnarray*}
H_0: \mbox{logit}\left\{p_i\right\} & = & \beta_0 \\
H_1: \mbox{logit}\left\{p_i\right\} & = & \beta_0 + \beta_1 x_i + \beta_2 N_1(x_i) + \beta_3 N_2(x_i) + \beta_4 N_3(x_i) \\
\end{eqnarray*}$$

By default, PROC LOGISTIC in SAS calculates the overall likelihood ratio test statistic and $p$-value. (By default, it also calculates the Wald and score versions of the overall test, which should be ignored.)  Under the null hypothesis, the likelihood ratio test statistic follows a chi-squared distribution with $4$ df. (More generally, for a natural cubic spline spline with $k$ df ($k+1$ knots), it follows a chi-square distribution with $k$ df.)

```{r example7, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS SELECT NONE;
PROC LOGISTIC DATA=Ron;
  ODS OUTPUT GlobalTests=G;
  EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) DEGREE=3 KNOTMETHOD=PERCENTILELIST(5 27.5 50 72.5 95) DETAILS);
  MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;    
RUN;
ODS SELECT ALL;

DATA LRTests;
  RETAIN Test df ChiSq ProbChiSq sValue;
  SET G;

  IF Test="Likelihood Ratio";
  
  sValue = -LOG(ProbChiSq)/LOG(2);
  Test="Age Overall";

  KEEP Test df ChiSq ProbChiSq sValue;
RUN;

TITLE "Likelihood Ratio Test";
PROC PRINT DATA=LRTests NOOBS;
  VAR Test DF ChiSq ProbChiSq sValue; 

  LABEL ProbChiSq="p-value"
    sValue="s-value";
    
  FORMAT sValue 6.2;
  FORMAT ProbChiSq ;
  FORMAT ChiSq 6.2;
RUN;
TITLE;
```

There is very strong evidence of an effect of age on the prevalence (log odds) of obesity.  The $p$-value is $\approx 0$, and the $s$-value is $31.4$.

# Test of Linear Effect of Age on Log Odds of Obesity

Another question of potential interest is whether the odds ratio for a fixed difference in ages is the same for two different starting ages. For example, is the odds ratio for 40 year olds vs. 30 year olds (a 10 year age difference) the same as the odds ratio for 50 year olds vs. 40 year olds (also a 10 year age difference)?  While it is possible to assess this hypothesis using the confidence (compatability) interval for the difference in log odds ratios (or ratio of odds ratios), it is difficult to interpret the magnitudes of these differences in differences, so $p$-values are more useful for these types of single parameter questions.

```{r dlor, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS EXCLUDE ALL;
PROC PLM RESTORE=NaturalCubicSpline;
    ODS OUTPUT Estimates=E;

    ESTIMATE "Age 50 v 40 v Age 40 v 30" AgeCS [1, 50] [-2, 40] [1, 30] / CL EXP ALPHA=0.03125;
RUN;

DATA E;
  SET E;

  sValue = -LOG(Probz)/LOG(2);
RUN;
ODS EXCLUDE NONE;

PROC PRINT DATA=E NOOBS LABEL;
  VAR Label LowerExp ExpEstimate UpperExp Probz sValue;
  LABEL Label='00'x
    LowerExp="Lower CL"
    ExpEstimate="Estimate"
    UpperExp="Upper CL"
    Probz="p-value"
    sValue="s-value";
  
  FORMAT sValue 6.2;
  FORMAT Probz ;

  TITLE "Ratio of Odds Ratios";
RUN;
TITLE;
```

There is little evidence of a difference between the odds ratio for 50 v. 40 and the odds ratio for 40 v. 30.  The $p$-value is $0.10$, and the $s$-value is $3.3$.

The null hypothesis of a *linear effect* of age on the log odds of obesity, e.g the log odds ratio is the same for every difference in age of the same amount regardless of starting age, can be tested using using a likelihood ratio test. 

The *test of linear effect* for age is the test of the hypotheses
$$\begin{eqnarray*}
H_0: \mbox{logit}\left\{p_i\right\} & = & \beta_0 + \beta_1 x_i \\
H_1: \mbox{logit}\left\{p_i\right\} & = & \beta_0 + \beta_1 x_i + \beta_2 N_1(x_i) + \beta_3 N_2(x_i) + \beta_4 N_3(x_i) \\
\end{eqnarray*}$$

Under the null hypothesis, the likelihood ratio test statistic follows a chi-squared distribution with $3$ df. (More generally, for a linear spline with $k-1$ knots, it follows a chi-square distribution with $k-1$ df.)

```{r example9, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS SELECT NONE;
PROC LOGISTIC DATA=Ron;
  ODS OUTPUT GlobalTests=Reduced;
  MODEL Obese(Event="Yes") = Age / LINK=LOGIT;
RUN;

PROC LOGISTIC DATA=Ron;
  ODS OUTPUT GlobalTests=Full;
  EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) DEGREE=3 KNOTMETHOD=PERCENTILELIST(5 27.5 50 72.5 95) DETAILS);
  MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;    
RUN;
ODS SELECT ALL;

DATA Reduced;
  LENGTH Test $30;
  RETAIN Test nPars Minus2LogLR;
  SET Reduced (RENAME=(ChiSq=Minus2LogLR));

  IF Test="Likelihood Ratio";
  
  Test="Age Linear";
  nPars = df + 1;

  KEEP Test nPars Minus2LogLR;
RUN;

DATA Full;
  RETAIN nPars_Full Minus2LogLR_Full;
  SET Full (RENAME=(ChiSq=Minus2LogLR_Full));

  IF Test="Likelihood Ratio";
  nPars_Full = df + 1;

  KEEP nPars_Full Minus2LogLR_Full;
RUN;

DATA LRTests;
  IF _N_ = 1 THEN SET Full;
  SET Reduced;
  
  Chisq = Minus2LogLR_Full-Minus2LogLR;
  df = nPars_Full - nPars;
  ProbChiSq = SDF("CHISQURE",Chisq,df);
  sValue = -LOG(ProbChiSq)/LOG(2);
    
  KEEP Test df ChiSq ProbChiSq sValue;    
RUN;

TITLE "Likelihood Ratio Test";
PROC PRINT DATA=LRTests NOOBS;
    VAR Test DF ChiSq ProbChiSq sValue;  

    FORMAT sValue 6.2;
    FORMAT ChiSq 6.2;
RUN;
TITLE;
```

There is very strong evidence of an non-linear effect of age on the log odds of obesity.  The $p$-value is $\approx 0$, and the $s$-value is $30.1$.

# Plotting the Estimated Regression Function

Using the SCORE statement in PROC PLM, we can obtain the estimated log odds for obesity for each age between 20 and 80 (the age range for adults included in the NHANES dataset). Using PROC SGPLOT, we can plot the entire regression function.

```{r example8, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
DATA AllAges;
    DO Age = 20 TO 80 BY 1;
        OUTPUT;
    END;
RUN;

ODS EXCLUDE ALL;
PROC PLM RESTORE=NaturalCubicSpline;
    SCORE DATA=AllAges OUT=Fitted Predicted LCLM UCLM;
RUN;
ODS EXCLUDE NONE;

PROC SGPLOT DATA=Fitted NOAUTOLEGEND;
    BAND X=Age Lower=LCLM Upper=UCLM / FILLATTRS=(COLOR=Cx1b9e77 TRANSPARENCY=0.7);
    SERIES X=Age Y=Predicted / LINEATTRS=(COLOR=Cx1b9e77) TRANSPARENCY=0.9;
    YAXIS LABEL="Logit (Log Odds) of Obesity";
RUN;
```

# Model Selection

For illustration, we will evaluate AIC and BIC for natural cubic spline regression models with 2-6 df (3-7 knots) using the recommended default knot placements.

```{r effN, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
PROC FREQ DATA=Ron;
  ODS SELECT OneWayFreqs;
	TABLE Obese / NOPERCENT NOCUM MISSING;
RUN;
```

Our effective sample size is $N=2592$.

```{r modelselection, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
%MACRO SelectCubicSplineDF;
  %DO k = 2 %TO 6;
    
    ODS EXCLUDE ALL;
                       
    PROC LOGISTIC DATA=Ron;
      ODS OUTPUT ScoreFitStat=S&k;
      EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) 
      KNOTMETHOD=PERCENTILELIST(%IF &k=2 %THEN 5 50 95;
                                %ELSE %IF &k=3 %THEN 5 35 65 95;
                                %ELSE %IF &k=4 %THEN 5 27.5 50 72.5 95;
                                %ELSE %IF &k=5 %THEN 5 23 41 59 77 95;
                                %ELSE %IF &k=6 %THEN 2.5 18.3333 34.1667 50 65.8333 81.6667 97.5;));
      MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;
    
      SCORE DATA=Ron FITSTAT;
    
      STORE CS&k;
    RUN;
    
    ODS EXCLUDE NONE;
        
    DATA S&k;
      SET S&k;
            
      k = &k;
      KEEP k LogLike;
    RUN;
        
    PROC PLM RESTORE=CS&k NOINFO;
      SCORE DATA=AllAges OUT=Fitted&k 
        LCLM=Lower_Logit 
        UCLM=Upper_Logit / ALPHA=0.03125;
    RUN;        

    DATA Fitted&k;
      SET Fitted&k;
            
      k = &k;
    RUN;
 

    %IF &k = 2 %THEN %DO;
      DATA ModelComparison;
        SET S&k;
      RUN;
            
      DATA CubicSplineFits;
        SET Fitted&k;
      RUN;
    %END;
    %ELSE %DO;
      PROC APPEND BASE=ModelComparison DATA=S&k FORCE;
      RUN;

      PROC APPEND BASE=CubicSplineFits DATA=Fitted&k FORCE;
      RUN;
    %END;
  %END;
%MEND SelectCubicSplineDF;

%SelectCubicSplineDF;

DATA ModelComparison;
	SET ModelComparison;
	
	AIC = -2*LogLike+2*(k+2);
  BIC = -2*LogLike+LOG(2592)*(k+2);
RUN;

PROC MEANS DATA=ModelComparison MIN NOPRINT;
  VAR AIC BIC;
  OUTPUT OUT=MinIC MIN= / AUTONAME;
RUN;

DATA ModelComparison;
  IF _N_=1 THEN SET MinIC;
  SET ModelComparison;
    
  Delta_AIC = AIC-AIC_Min;
  Delta_BIC = BIC-BIC_Min;
  
  LR_AIC = EXP(1/2*Delta_AIC);
  LR_BIC = EXP(1/2*Delta_BIC);
  
  KEEP k LogLike AIC BIC Delta_AIC Delta_BIC LR_AIC LR_BIC;
RUN;

TITLE "Akaike's information criterion";
PROC PRINT DATA=ModelComparison NOOBS;
	VAR k LogLike AIC Delta_AIC LR_AIC;
    
  FORMAT LogLike AIC Delta_AIC 10.1;
  FORMAT LR_AIC 10.2;
RUN;
TITLE;
```

Based on AIC, the best model is the natural cubic spline with 4 df, and there is very strong evidence against the models with fewer df.

```{r example10, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
TITLE "Schwarz's criterion";
PROC PRINT DATA=ModelComparison NOOBS;
	VAR k LogLike BIC Delta_BIC LR_BIC;
    
  FORMAT LogLike BIC Delta_BIC 10.1;
  FORMAT LR_BIC 10.2;
RUN;
TITLE;
```

Based on BIC, the best model is the natural cubic spline with 4 df, and there is weak evidence against the model with 2 df. Nonetheless, we would not typically change the df for the natural cubic spline in the absence of more conclusive evidence against the pre-specified model because obtaining valid statistical inferences (standard errors, confidence/compatability intervals) after model selection is very challenging.

The estimated regression functions (log odds of obesity as a function of age) from the pre-specified, AIC-optimal and BIC-optimal natural cubic spline with 4 df can be plotted using PROC SGPLOT. For comparison, we also plot the estimated regression function for natural cubic splines with 2 df and 6 df.


```{r example11, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
PROC SGPLOT DATA=CubicSplineFits;
  STYLEATTRS DATACOLORS=(Cx1b9e77 Cxd95f02 Cx7570b3 Cxe7298a Cx66a61e Cxe6ab02 Cxa6761d Cx666666);
  BAND X=Age Lower=Lower_Logit Upper=Upper_Logit /
      GROUP=k TRANSPARENCY=0.7;
  YAXIS LABEL="Logit (Log Odds) of Obesity";
  WHERE k = 2 OR k = 4 OR k=6;
RUN;
```

Alternatively, the estimated prevalence of obesity from the pre-specified, AIC-optimal and BIC-optimal natural cubic spline with 4 df can be plotted using PROC SGPLOT.  For comparison, we also plot the estimated prevalence for natural cubic splines with 2 df and 6 df.

```{r example12, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
DATA Tmp;
  SET CubicSplineFits;
    
  Lower_Prob = 1/(1+EXP(-Lower_Logit));
  Upper_Prob = 1/(1+EXP(-Upper_Logit));
RUN;

PROC SGPLOT DATA=Tmp;
  STYLEATTRS DATACOLORS=(Cx1b9e77 Cxd95f02 Cx7570b3 Cxe7298a Cx66a61e Cxe6ab02 Cxa6761d Cx666666);
  BAND X=Age Lower=Lower_Prob Upper=Upper_Prob /
      GROUP=k TRANSPARENCY=0.7;
  YAXIS LABEL="Prevalence of Obesity";
  WHERE k = 2 OR k = 4 OR k = 6;
RUN;
```

# Recommended Practice

In practice, we would typically recommend using a natural cubic spline with 4 df using the recommended percentiles for knot placement (unless there are a lot of ties) as a reasonable default (as noted earlier, with small sample sizes, you might use only 2 or 3 df).  For model checking, we recommend evaluating the use of one additional df (5 v 4 in the usual case) based on BIC, repeating as necessary. After an adequate model is found, we recommend interacting with the model primarily using PROC PLM with the non-positional syntax. Where appropriate, you should calculate (partial) likelihood ratio tests by hand.  An example of the typical code follows.

```{r example13, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
LIBNAME NHANES "../../../BMI552_Datasets/NHANES_May2023/";
*LIBNAME NHANES "~/my_shared_file_links/u48718377/NHANES";
OPTIONS FMTSEARCH=(NHANES.formats_NHANES work) NODATE NONUMBER;
TITLE1; TITLE2;
ODS NOPROCTITLE;
ODS GRAPHICS / LOESSMAXOBS=20000;

DATA Ron;
  SET NHANES.NHANES;
RUN;

ODS SELECT NONE;
PROC LOGISTIC DATA=Ron;
  EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) DEGREE=3 KNOTMETHOD=PERCENTILELIST(5 27.5 50 72.5 95) DETAILS);
  MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;    
  
  OUTPUT OUT=Tmp RESCHI=Residual PREDICTED=Fitted; 
    
  STORE Age_4df;
RUN;
ODS SELECT ALL;
```

```{r example14, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
TITLE "Age NCS w/ 4 df";
PROC LOGISTIC DATA=Ron;
  ODS SELECT ResponseProfile FitStatistics;

  EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) DEGREE=3 KNOTMETHOD=PERCENTILELIST(5 27.5 50 72.5 95) DETAILS);
  MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;    
RUN;
TITLE;

TITLE "Age NCS w/ 5 df";
PROC LOGISTIC DATA=Ron;
  ODS SELECT FitStatistics;

  EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) DEGREE=3 KNOTMETHOD=PERCENTILELIST(5 23 41 59 77 95) DETAILS);
  MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;    
RUN;
TITLE;
```

```{r calc1, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
DATA Calculator;
    BIC_4df = 9390.238 + LOG(2592)*5;
    BIC_5df = 9388.797 + LOG(2592)*6;

    Delta_BIC = BIC_5df - BIC_4df;

    KEEP BIC_4df BIC_5df Delta_BIC;   
RUN;

TITLE "BIC Calculator";
PROC PRINT DATA=Calculator NOOBS;
RUN;
TITLE;
```

If (partial) likelihood ratio tests are required, you should fit the relevant models to get the log-likelihoods and calculate the test statistics (and $p$-values) by hand.

```{r example18, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
TITLE "Reduced Model (Intercept Only)";
PROC LOGISTIC DATA=Ron;
  ODS SELECT FitStatistics;
  MODEL Obese(Event="Yes") = / LINK=LOGIT;
RUN;
TITLE;

TITLE "Reduced Model (Age Linear)";
PROC LOGISTIC DATA=Ron;
  ODS SELECT FitStatistics;

  MODEL Obese(Event="Yes") = Age / LINK=LOGIT;    
RUN;
TITLE;

TITLE "Full Model (Age NCS)";
PROC LOGISTIC DATA=Ron;
  ODS SELECT FitStatistics;
  EFFECT AgeCS=SPLINE(Age / NATURALCUBIC BASIS=TPF(NOINT) DEGREE=3 KNOTMETHOD=PERCENTILELIST(5 27.5 50 72.5 95) DETAILS);
  MODEL Obese(Event="Yes") = AgeCS / LINK=LOGIT;    
RUN;
TITLE;
```


```{r calc2, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
DATA Calculator;
    Minus2LL0 = 9440.367;
    Minus2LL1 = 9390.268;

    df0 = 1;
    df1 = 5;

    Chisq = Minus2LL0 - Minus2LL1;    
    df = df1 - df0;
    ProbChiSq = SDF("CHISQURE",Chisq,df);
    sValue = -LOG(ProbChiSq)/LOG(2);
    
    KEEP Chisq df ProbChiSq sValue;   
RUN;

TITLE "Chi-Square Calculator";
PROC PRINT DATA=Calculator NOOBS;
RUN;
TITLE;

DATA Calculator;
    Minus2LL0 = 9435.432;
    Minus2LL1 = 9390.268;

    df0 = 2;
    df1 = 5;

    Chisq = Minus2LL0 - Minus2LL1;    
    df = df1 - df0;
    ProbChiSq = SDF("CHISQURE",Chisq,df);
    sValue = -LOG(ProbChiSq)/LOG(2);
    
    KEEP Chisq df ProbChiSq sValue;   
RUN;

TITLE "Chi-Square Calculator";
PROC PRINT DATA=Calculator NOOBS;
RUN;
TITLE;
```

The overall likelihood ratio test statistic for any *effect* of age is $50.10 = 9440.367-9390.268$ on 4 df, the $p$-value is $3.4 \times 10^{-10} \approx 0$, and the $s$-value is $31.4$.  

The (partial) likelihood ratio test statistic for non-linearity in the effect of age is $45.16 =
9435.459-9390.268$ on 3 df, the $p$-value is $8.5 \times 10^{-10} \approx 0$, and the $s$-value is $30.1$.  

```{r example19, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS EXCLUDE ALL;
PROC PLM RESTORE=Age_4df;
    ODS OUTPUT Estimates=E;

    ESTIMATE "Age 30 v 50" AgeCS [1, 30] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 40 v 50" AgeCS [1, 40] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 60 v 50" AgeCS [1, 60] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 70 v 50" AgeCS [1, 70] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 80 v 50" AgeCS [1, 80] [-1, 50] / CL EXP ALPHA=0.03125;
RUN;
ODS EXCLUDE NONE;

PROC PRINT DATA=E NOOBS LABEL;
    VAR Label LowerExp ExpEstimate UpperExp;
    LABEL Label='00'x
        LowerExp="Lower CL"
        ExpEstimate="Estimate"
        UpperExp="Upper CL";
    TITLE "Odds Ratio";
RUN;
TITLE;
```

```{r example20, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS EXCLUDE ALL;
PROC PLM RESTORE=Age_4df;
    ODS OUTPUT Estimates=E;

    ESTIMATE "Age 40 v 30" AgeCS [1, 40] [-1, 30] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 50 v 40" AgeCS [1, 50] [-1, 40] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 60 v 50" AgeCS [1, 60] [-1, 50] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 70 v 60" AgeCS [1, 70] [-1, 60] / CL EXP ALPHA=0.03125;
    ESTIMATE "Age 80 v 70" AgeCS [1, 80] [-1, 70] / CL EXP ALPHA=0.03125;
RUN;
ODS EXCLUDE NONE;

PROC PRINT DATA=E NOOBS LABEL;
    VAR Label LowerExp ExpEstimate UpperExp;
    LABEL Label='00'x
        LowerExp="Lower CL"
        ExpEstimate="Estimate"
        UpperExp="Upper CL";
    TITLE "Odds Ratio";
RUN;
TITLE;
```


```{r example21, engine="sashtml5", engine.path=saspath, collectcode=TRUE, error=TRUE}
ODS EXCLUDE ALL;
PROC PLM RESTORE=Age_4df;
    ODS OUTPUT Estimates=E;

    ESTIMATE "Age 30" Intercept 1 AgeCS [1, 30] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 40" Intercept 1 AgeCS [1, 40] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 50" Intercept 1 AgeCS [1, 50] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 60" Intercept 1 AgeCS [1, 60] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 70" Intercept 1 AgeCS [1, 70] / CL ILINK ALPHA=0.03125;
    ESTIMATE "Age 80" Intercept 1 AgeCS [1, 80] / CL ILINK ALPHA=0.03125;
RUN;
ODS EXCLUDE NONE;

PROC PRINT DATA=E NOOBS LABEL;
    VAR Label LowerMu Mu UpperMu;
    LABEL Label='00'x
        Mu="Estimate"
        LowerMu="Lower CL"
        UpperMu="Upper CL";
    TITLE "Prevalence of Obesity";
RUN;
TITLE;